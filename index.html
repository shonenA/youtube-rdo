<!DOCTYPE html>
<html>
  <head>
    <title>Youtube Radio</title>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
  </head>
  <body>
    <h1 class="title"></h1>
    <div id="movie-wrap">
      <div id="movie-div"></div>
    </div>
    <form class="form-inline">
      <div class="form-group">
        <input type="text" class="form-control" name="youtube-id" placeholder="Youtube id" />
      </div>
      <div class="form-group">
        <input type="button" class="btn btn-default" name="btn-play" value="PLAY" />
        <input type="button" class="btn btn-default" name="btn-next" value="NEXT" />
      </div>
    </form>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script>
    var favorite = ['LZSnoaLWCVU', 'lO59nQ8xy98', 'j61CfhcqheY'];

    Array.prototype.getRandomElement = function() {
      if( this.length == 0 ) return null;
      return this[Math.floor( Math.random()*this.length )];
    }

    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player = null;
    var playerID;

    function onHashChange() {
      changeVideo(location.hash.substr(1));
    }

    function changeHashSafely(hash) {
      $(window).unbind('hashchange', onHashChange);
      location.hash = hash;
      setTimeout(function(){$(window).bind('hashchange', onHashChange);}, 0);
    }

    function setTitle(title) {
      if( !title ) {
        $('h1.title').text('Youtube Radio');
      } else {
        $('h1.title').text(title);
        title = 'Youtube Radio : ' + title;
        document.title = title;
      }
    }

    function onYouTubeIframeAPIReady() {
      onHashChange();

      $(window).bind('hashchange', onHashChange);

      $('input[name=btn-play]').click(function() {
          var videoId = $('input[name=youtube-id]').val();
          changeVideo(videoId);
        });
      $('input[name=btn-next]').click(function() {
          if( player ) getNextVideo();
        });
      $('input[name=youtube-id]').val(favorite.getRandomElement());
    }

    function changeVideo(id) {
      playerID = id;

      if( !playerID ) {
        setTitle('');
      }

      if( playerID ) {
        $('input[name=youtube-id]').val(playerID);
        $.get('https://gdata.youtube.com/feeds/api/videos/' + id + '?v=2&alt=json', function(data) {
          setTitle(data.entry.title['$t']);
        }, 'json');
      }

      if( player ) {
        player.loadVideoById(id);
      } else {
        player = new YT.Player('movie-div', {
          height: 390,
          width: 640,
          videoId: id,
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      changeHashSafely('#' + id);
    }

    function onPlayerReady(event) {
      event.target.playVideo();
    }

    function getNextVideo() {
      $.get('https://gdata.youtube.com/feeds/api/videos/' + playerID + '/related?v=2&alt=json', function(data) {
            var entries = data.feed.entry.filter(function(e) {
              var acc = e['yt$accessControl'];
              for( var i in acc ) {
                if( acc[i].action == 'embed' && acc[i].permission == 'allowed' )
                  return true;
              }
              return false;
            });

            if( entries.length == 0 ) {
              alert('no related video!');
              return;
            }
            var selected = Math.floor(Math.random() * entries.length);
            var id = entries[selected]['media$group']['yt$videoid']['$t'];
            changeVideo(id);
          },
          'json');
    }

    function onPlayerStateChange(event) {
      if ( event.data == YT.PlayerState.ENDED ) {
        getNextVideo();
      }
    }
    </script>
  </body>
</html>
